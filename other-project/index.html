<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar â€“ AI Assistant</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- Vercel Geist UI Inspired Styles --- */
        :root {
            --bg-light: #ffffff;
            --bg-dark: #000000;
            --text-light: #000000;
            --text-dark: #ffffff;
            --panel-dark: #111111;
            --border-light: #eaeaea;
            --border-dark: #333333;
            --accent: #0070f3;
            --geist-gray: #666666;
        }

        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            flex-direction: column;
        }

        .light-theme { background-color: var(--bg-light); color: var(--text-light); }
        .dark-theme { background-color: var(--bg-dark); color: var(--text-dark); }

        .panel {
            transition: background-color 0.2s;
            border-color: var(--border-light);
        }
        .dark-theme .panel { border-color: var(--border-dark); }
        .light-theme .panel { background-color: var(--bg-light); }
        .dark-theme .panel { background-color: var(--panel-dark); }

        .chat-bubble { max-width: 90%; padding: 10px 16px; border-radius: 12px; word-wrap: break-word; line-height: 1.6; }
        .user-bubble { background-color: var(--accent); color: white; }
        .stellar-bubble { background-color: transparent; padding: 0; }
        .stellar-bubble a { color: var(--accent); text-decoration: none; border-bottom: 1px solid var(--accent); }
        .stellar-bubble a:hover { background-color: var(--accent); color: white; }
        .stellar-bubble ul { list-style-position: inside; padding-left: 8px; }
        .stellar-bubble h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; }

        .toolbar-icon { cursor: pointer; transition: color 0.2s ease; color: var(--geist-gray); }
        .toolbar-icon:hover { color: var(--accent); }

        .input-container {
            position: relative;
            display: flex;
            align-items: center;
            padding: 8px;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            background-color: var(--bg-light);
        }
        .dark-theme .input-container {
            border-color: var(--border-dark);
            background-color: var(--bg-dark);
        }
        .input-container:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 112, 243, 0.2);
        }

        .input-field {
            flex-grow: 1;
            background: transparent;
            border: none;
            outline: none;
            padding: 8px 48px 8px 40px;
            font-size: 1rem;
            line-height: 1.5;
            resize: none;
            overflow-y: hidden;
        }

        .input-icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--geist-gray);
        }
        .input-icon.mic { left: 16px; cursor: pointer; }
        .input-icon.send { right: 16px; background-color: var(--accent); color: white; border-radius: 8px; padding: 6px; cursor: pointer; }
        .input-icon.send:hover { background-color: #0056b3; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .dark-theme ::-webkit-scrollbar-thumb { background: #444; }

        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .switch { position: relative; display: inline-block; width: 46px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 26px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked+.slider { background-color: var(--accent); }
        input:checked+.slider:before { transform: translateX(20px); }

        .data-card { margin-top: 12px; padding: 16px; border: 1px solid var(--border-light); border-radius: 8px; }
        .dark-theme .data-card { border-color: var(--border-dark); }
        .news-article { margin-top: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border-light); }
        .dark-theme .news-article { border-color: var(--border-dark); }
        .news-article:last-child { border-bottom: none; }

        .error-message {
            background-color: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .dark-theme .error-message {
            background-color: #422;
            border-color: #633;
            color: #faa;
        }

        .mic-recording {
            color: #ef4444 !important;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>

<body class="light-theme">

    <div id="app-container" class="w-full h-full flex flex-col opacity-0">
        <header class="flex justify-between items-center text-center p-4 border-b panel">
            <div class="w-10"></div> <!-- Spacer -->
            <h1 class="text-xl font-semibold tracking-tight">Stellar</h1>
            <div id="settings-btn" class="toolbar-icon w-10" title="Settings"><i class="material-icons">settings</i></div>
        </header>
        <main class="flex-grow flex flex-col overflow-hidden">
            <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4"></div>
        </main>
        <footer class="p-2 sm:p-4 border-t panel">
            <div class="input-container">
                <div class="input-icon mic" id="mic-button"><i class="material-icons">mic</i></div>
                <textarea id="chat-input" class="input-field" placeholder="Ask Stellar anything..." rows="1"></textarea>
                <div id="send-button" class="input-icon send"><i class="material-icons">arrow_upward</i></div>
            </div>
        </footer>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-black border border-gray-200 dark:border-gray-800 p-6 rounded-2xl w-full max-w-md">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Settings</h2>
                <button id="close-settings" class="toolbar-icon"><i class="material-icons">close</i></button>
            </div>
            <div class="mt-6 space-y-6">
                <div class="flex justify-between items-center">
                    <span>Dark Mode</span>
                    <label class="switch"><input type="checkbox" id="dark-mode-toggle"><span class="slider"></span></label>
                </div>
                <div class="flex justify-between items-center">
                    <span>Clear Chat History</span>
                    <button id="clear-history-btn" class="px-3 py-1 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const CONFIG = {
                API_KEY: "AIzaSyCgX5yszHAZyBe9_S9GLw-JKXWSaUBqFsY",
                PROXY_URL: 'https://blkproxy.vercel.app/api/proxy?url=',
                API_BASE_URL: 'https://swipeapis.vercel.app',
                MODEL_NAME: 'gemini-1.5-flash-latest' // Updated to latest stable model
            };

            // --- GET ALL HTML ELEMENTS ---
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const micButton = document.getElementById('mic-button');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsBtn = document.getElementById('close-settings');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const appContainer = document.getElementById('app-container');

            let chatHistory = [];
            let isRecording = false;
            const availableTools = {};

            // --- AUTO-RESIZING TEXTAREA ---
            const adjustTextareaHeight = () => {
                chatInput.style.height = 'auto';
                const maxHeight = 200;
                chatInput.style.height = Math.min(chatInput.scrollHeight, maxHeight) + 'px';
            };
            chatInput.addEventListener('input', adjustTextareaHeight);

            // --- Message Handling ---
            const addMessage = (sender, message, isRawHtml = false, existingId = null) => {
                const messageId = existingId || `msg-${Date.now()}-${Math.random()}`;
                const messageElement = document.createElement('div');
                messageElement.className = 'w-full flex fade-in';
                messageElement.id = messageId;

                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble';

                if (sender === 'user') {
                    messageElement.classList.add('justify-end');
                    bubble.classList.add('user-bubble');
                    bubble.textContent = message;
                } else if (sender === 'stellar') {
                    messageElement.classList.add('justify-start');
                    bubble.classList.add('stellar-bubble');
                    if (isRawHtml) {
                        bubble.innerHTML = message;
                    } else {
                        bubble.textContent = message;
                    }
                } else if (sender === 'system') {
                    messageElement.classList.add('justify-center');
                    bubble.classList.add('text-gray-500', 'text-sm', 'italic');
                    bubble.textContent = message;
                }

                messageElement.appendChild(bubble);
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Only save user and model messages to history (not system messages or existing ones)
                if ((sender === 'user' || sender === 'stellar') && !existingId) {
                    const historyEntry = {
                        role: sender === 'user' ? 'user' : 'model',
                        parts: [{ text: isRawHtml ? message.replace(/<[^>]*>/g, '') : message }]
                    };
                    chatHistory.push(historyEntry);
                    saveChatHistory();
                }
                return messageId;
            };

            const showTypingIndicator = (message = null) => {
                hideTypingIndicator();
                const typingElement = document.createElement('div');
                typingElement.id = 'typing-indicator';
                typingElement.className = 'w-full flex justify-start fade-in';

                if (message) {
                    typingElement.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400 pl-4">${message}</p>`;
                } else {
                    const bubbleContent = '<div class="chat-bubble stellar-bubble flex items-center space-x-1"><span class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></span><span class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></span><span class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></span></div>';
                    typingElement.innerHTML = bubbleContent;
                }

                chatMessages.appendChild(typingElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            const hideTypingIndicator = () => {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
            };

            const simpleMarkdownToHtml = (text) => {
                if (!text) return '';
                let html = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
                    .replace(/`([^`]+)`/g, '<code class="bg-gray-100 dark:bg-gray-800 px-1 rounded">$1</code>');

                // Process lists by finding consecutive list items
                html = html.replace(/((^\s*[-*]\s+.*(?:\n|$))+)/gm, (match) => {
                    const items = match.trim().split('\n').map(item => `<li>${item.replace(/^\s*[-*]\s+/, '')}</li>`).join('');
                    return `<ul class="list-disc pl-4 my-2">${items}</ul>`;
                });

                html = html.replace(/((^\s*\d+\.\s+.*(?:\n|$))+)/gm, (match) => {
                    const items = match.trim().split('\n').map(item => `<li>${item.replace(/^\s*\d+\.\s+/, '')}</li>`).join('');
                    return `<ol class="list-decimal pl-4 my-2">${items}</ol>`;
                });

                return html.replace(/\n/g, '<br>').replace(/<br>(<\/?(ul|ol|li))/g, '$1');
            };

            // --- Main Logic ---
            const handleSendMessage = async () => {
                const userInput = chatInput.value.trim();
                if (userInput === '') return;

                // Add user message and clear input
                addMessage('user', userInput);
                chatInput.value = '';
                adjustTextareaHeight();
                showTypingIndicator();

                try {
                    const finalResponse = await getStellarResponse();
                    hideTypingIndicator();
                    const processedResponse = simpleMarkdownToHtml(finalResponse);
                    addMessage('stellar', processedResponse, true);
                } catch (error) {
                    hideTypingIndicator();
                    console.error("Error from Stellar:", error);
                    const errorHtml = `<div class="error-message">I encountered an error: ${error.message}</div>`;
                    addMessage('stellar', errorHtml, true);
                }
            };

            // --- NATIVE TOOL CALLING ARCHITECTURE ---
            const getStellarResponse = async () => {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.MODEL_NAME}:generateContent?key=${CONFIG.API_KEY}`;

                // Proper system instruction format for Gemini API
                const systemInstruction = {
                    parts: [{ text: `You are Stellar, a friendly, brilliant, and extremely capable personal AI assistant created by Bhavesh.

## Your Persona
- Your personality is helpful, friendly, curious, and slightly informal. You're like a super-smart friend who is amazing with technology.
- Use emojis to make your responses more engaging, but only where it feels natural. One or two per response is a good balance.
- You were created by a brilliant developer named Bhavesh. If asked who created you, who made you, or about your "father", you must say that Bhavesh created you.

## Core Functionality & Rules
- **CRITICAL:** You MUST use the provided tools when necessary. Do not answer questions that require real-time data or external APIs by making up information.
- **Contextual Awareness:** ALWAYS pay close attention to the conversation history. If the user's request is a follow-up (e.g., "summarize this", "what about in the UK?", "show me more"), you MUST use the information from the previous turn as context to modify your tool calls.
- **Proactive Intelligence:** Be proactive. If a query is vague, infer the user's intent. "how's apple?" implies a stock check for AAPL. "latest news" implies top headlines.
- **Input Validation (MANDATORY):**
    - **Ticker Symbols:** Before using a tool, validate stock symbols. If a symbol looks like a common company name or a typo, correct it to the official symbol. Examples: 'apple' -> 'AAPL', 'APPL' -> 'AAPL', 'google' -> 'GOOGL', 'microsoft' -> 'MSFT', 'nvidia' -> 'NVDA'.
    - **Dates:** You MUST validate dates. The current date is ${new Date().toLocaleDateString()}. Any request for HISTORICAL data for a date AFTER today is impossible. If a user asks for a future date, you MUST respond with a polite text message explaining that you cannot fetch data from the future. Do not attempt to call a tool with a future date.

## Tool Delegation Strategy
Your main goal is to decide which tool to use based on the user's request.

1. **Special Case - "Who is Bhavesh?":** If asked "who is Bhavesh", "tell me about Bhavesh", etc., you MUST use the \`google_search\` tool with the specific query "iambhvsh".

2. **Finance Queries (with Date Handling):**
   - To get current stock data: \`fetch_stock_data({ticker: "AAPL"})\`
   - To get historical stock data: \`fetch_stock_data({ticker: "AAPL", start_date: "2024-08-20"})\`
   - The API does not support multi-stock comparisons in a single call. You must call \`fetch_stock_data\` for each ticker individually, then combine the results in your text response, preferably in a markdown table.

3. **News Workflow (Very Important!):**
   - **Fetching News:** Use the \`fetch_news\` tool. If a date is given without a topic, you MUST add \`q: "news"\` to the parameters. Handle relative dates like "yesterday" or "today".
   - **Summarizing News:** This is a **two-step thought process**. AFTER getting news, if the user asks for a summary, you respond with a text message where you provide a list of the news titles and write a short summary for each one yourself. Do NOT call another tool.
   - **"Show More" News:** There is no tool for this. You must look at the last news query in the history and call the \`fetch_news\` tool again with the same parameters, but incrementing the \`start\` index by 10.

4. **General Web Search:** Use the \`google_search\` tool for all other general knowledge, real-time info, etc.` }]
                };

                // Filter out system messages and function calls from chat history for API
                const filteredHistory = chatHistory.filter(entry =>
                    entry.role === 'user' || entry.role === 'model'
                ).map(entry => {
                    // Ensure proper role format
                    return {
                        role: entry.role,
                        parts: entry.parts
                    };
                });

                const requestBody = {
                    system_instruction: systemInstruction,
                    contents: filteredHistory,
                    tools: [{ functionDeclarations: toolDeclarations }],
                    generationConfig: {
                        temperature: 0.7,
                        topP: 0.8,
                        topK: 40
                    }
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-goog-api-key': CONFIG.API_KEY
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorData;
                        try {
                            errorData = JSON.parse(errorText);
                        } catch (e) {
                            throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                        }

                        const errorMessage = errorData.error?.message || `API request failed with status ${response.status}`;
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (!candidate || !candidate.content || !candidate.content.parts || candidate.content.parts.length === 0) {
                        // If the model stops, it may not have any parts, but we might have a finishReason.
                        if (candidate && candidate.finishReason && candidate.finishReason !== "STOP") {
                             throw new Error(`API response stopped for reason: ${candidate.finishReason}`);
                        }
                        // It's possible to get no parts if the model has nothing to say.
                        return "I'm not sure how to respond to that.";
                    }

                    const parts = candidate.content.parts;
                    const functionCallPart = parts.find(p => p.functionCall);
                    const textParts = parts.filter(p => p.text).map(p => p.text).join("");

                    if (functionCallPart) {
                        const functionCall = functionCallPart.functionCall;
                        const functionName = functionCall.name;
                        const functionArgs = functionCall.args || {};

                        // Display conversational text if available, otherwise show a generic tool message.
                        if (textParts) {
                            showTypingIndicator(textParts);
                        } else {
                            showTypingIndicator(`Using the ${functionName} tool...`);
                        }

                        if (availableTools[functionName]) {
                            try {
                                const toolResult = await availableTools[functionName](functionArgs);

                                chatHistory.push({ role: 'model', parts: candidate.content.parts });
                                chatHistory.push({
                                    role: 'function',
                                    parts: [{ functionResponse: { name: functionName, response: toolResult } }]
                                });

                                // Recursively call to get the final text response
                                return await getStellarResponse();

                            } catch (error) {
                                console.error(`Error executing tool ${functionName}:`, error);
                                throw new Error(`Tool execution failed: ${error.message}`);
                            }
                        } else {
                            throw new Error(`Unknown tool requested: ${functionName}`);
                        }
                    } else if (textParts) {
                        // If there's only text, return it
                        return textParts;
                    }

                    throw new Error("Unable to process the response from the API. No text or function call found.");

                } catch (error) {
                    console.error("API Error Details:", error);
                    throw error;
                }
            };

            const fetchViaProxy = async (endpoint) => {
                const finalUrl = CONFIG.PROXY_URL + encodeURIComponent(`${CONFIG.API_BASE_URL}${endpoint}`);
                try {
                    const response = await fetch(finalUrl);
                    if (!response.ok) {
                        throw new Error(`Network request failed with status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.error) {
                        throw new Error(data.error.message || 'An unknown API error occurred');
                    }
                    return data;
                } catch (error) {
                    console.error(`Error fetching from ${endpoint}:`, error);
                    throw error;
                }
            };

            const buildQueryString = (params) => {
                const filtered = Object.fromEntries(
                    Object.entries(params || {}).filter(([_, v]) => v != null && v !== '')
                );
                return new URLSearchParams(filtered).toString();
            };

            // --- Tool Implementations ---
            availableTools.google_search = async ({ query }) => {
                if (!query || query.trim() === '') {
                    throw new Error('Search query cannot be empty');
                }
                return await fetchViaProxy(`/search/?q=${encodeURIComponent(query.trim())}`);
            };

            availableTools.fetch_stock_data = async ({ ticker, start_date, end_date }) => {
                if (!ticker || ticker.trim() === '') {
                    throw new Error('Stock ticker cannot be empty');
                }
                const cleanTicker = ticker.trim().toUpperCase();
                const params = buildQueryString({start_date, end_date});
                const endpoint = `/finance/${cleanTicker}${params ? '?' + params : ''}`;
                return await fetchViaProxy(endpoint);
            };

            availableTools.fetch_news = async ({ q, category, region, from_date, to_date }) => {
                const params = buildQueryString({q, category, region, from_date, to_date});
                const endpoint = `/news/${params ? '?' + params : ''}`;
                return await fetchViaProxy(endpoint);
            };

            // --- Tool Definitions for Gemini ---
            const toolDeclarations = [
                {
                    name: "google_search",
                    description: "Get information from the web. Use for general knowledge, current events, weather, sports scores, etc.",
                    parameters: {
                        type: "OBJECT",
                        properties: {
                            query: { type: "STRING", description: "The search query." }
                        },
                        required: ["query"]
                    }
                },
                {
                    name: "fetch_stock_data",
                    description: "Get financial data for a stock ticker. Can be for the current day or a specific historical date.",
                    parameters: {
                        type: "OBJECT",
                        properties: {
                            ticker: { type: "STRING", description: "The stock ticker symbol, e.g., GOOGL, AAPL." },
                            start_date: { type: "STRING", description: "The start date for historical data (YYYY-MM-DD). Use for single-day queries." },
                            end_date: { type: "STRING", description: "The end date for historical data (YYYY-MM-DD). Use for date ranges." }
                        },
                        required: ["ticker"]
                    }
                },
                {
                    name: "fetch_news",
                    description: "Get news articles from around the world. Can be top headlines or articles matching a query, category, or date range.",
                    parameters: {
                        type: "OBJECT",
                        properties: {
                            q: { type: "STRING", description: "A specific search query for news." },
                            category: { type: "STRING", description: "A news category, e.g., 'technology', 'business'." },
                            region: { type: "STRING", description: "The two-letter region code, e.g., 'US', 'GB'." },
                            from_date: { type: "STRING", description: "The start date for news articles (YYYY-MM-DD)." },
                            to_date: { type: "STRING", description: "The end date for news articles (YYYY-MM-DD)." }
                        }
                    }
                }
            ];

            // --- UI & Settings ---
            const applyTheme = (theme) => {
                document.body.className = theme === 'dark' ? 'dark-theme' : 'light-theme';
                darkModeToggle.checked = theme === 'dark';
                try {
                    sessionStorage.setItem('stellar-theme', theme);
                } catch (e) {
                    console.warn('Could not save theme preference');
                }
            };

            // --- Speech Recognition ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                const recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                micButton.addEventListener('click', () => {
                    if (isRecording) {
                        recognition.stop();
                        return;
                    }

                    micButton.classList.add('mic-recording');
                    isRecording = true;
                    recognition.start();
                });

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    chatInput.value = transcript;
                    adjustTextareaHeight();
                    handleSendMessage();
                };

                recognition.onend = () => {
                    micButton.classList.remove('mic-recording');
                    isRecording = false;
                };

                recognition.onerror = (event) => {
                    micButton.classList.remove('mic-recording');
                    isRecording = false;
                    console.error('Speech recognition error:', event.error);
                    addMessage('system', `Speech recognition error: ${event.error}`);
                };
            } else {
                micButton.style.display = 'none';
            }

            // --- Event Listeners ---
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });

            sendButton.addEventListener('click', handleSendMessage);

            settingsBtn.addEventListener('click', () => {
                settingsModal.classList.remove('hidden');
            });

            closeSettingsBtn.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });

            // Close modal when clicking outside
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.classList.add('hidden');
                }
            });

            darkModeToggle.addEventListener('change', () => {
                applyTheme(darkModeToggle.checked ? 'dark' : 'light');
            });

            clearHistoryBtn.addEventListener('click', () => {
                chatHistory = [];
                chatMessages.innerHTML = '';
                saveChatHistory();
                addMessage('system', 'Chat history cleared.');
                settingsModal.classList.add('hidden');
            });

            // --- Storage Functions ---
            const saveChatHistory = () => {
                try {
                    sessionStorage.setItem('stellar-chat-history', JSON.stringify(chatHistory));
                } catch (e) {
                    console.warn('Could not save chat history');
                }
            };

            const loadChatHistory = () => {
                try {
                    const savedHistory = sessionStorage.getItem('stellar-chat-history');
                    if (savedHistory) {
                        const parsedHistory = JSON.parse(savedHistory);
                        chatHistory = parsedHistory.filter(entry =>
                            entry.role === 'user' || entry.role === 'model'
                        );
                        chatMessages.innerHTML = '';

                        chatHistory.forEach(entry => {
                            if (entry.role && entry.parts && entry.parts[0] && entry.parts[0].text) {
                                if (entry.role === 'user') {
                                    addMessage('user', entry.parts[0].text, false, `history-${Math.random()}`);
                                } else if (entry.role === 'model') {
                                    addMessage('stellar', simpleMarkdownToHtml(entry.parts[0].text), true, `history-${Math.random()}`);
                                }
                            }
                        });
                    }
                } catch (e) {
                    console.warn('Could not load chat history:', e);
                    chatHistory = [];
                }
            };

            // --- Initialization ---
            const init = () => {
                try {
                    const savedTheme = sessionStorage.getItem('stellar-theme') || 'light';
                    applyTheme(savedTheme);
                } catch (e) {
                    applyTheme('light');
                }

                loadChatHistory();

                if (chatHistory.length === 0) {
                    addMessage('stellar', 'Hello! I am Stellar, your AI assistant created by Bhavesh. How can I help you today? ðŸš€');
                }

                // Smooth app appearance
                setTimeout(() => {
                    appContainer.classList.add('fade-in');
                    appContainer.style.opacity = 1;
                }, 100);

                // Focus on input
                chatInput.focus();
            };

            init();
        });
    </script>
</body>

</html>
